# 🚙 DORORO PORTING MANUAL

## 목차

1. 환경 설정
2. 배포
3. 외부 서비스
4. 시연 시나리오

## 1. 환경 설정

### 🔨 개발 환경

-   FrontEnd
    -   IDE : VisualStudio Code
    -   JavaScript v
    -   React v
-   BackEnd
    -   IDE : IntelliJ
    -   JDK17
    -   SpringBoot v3.2.5
-   InfraStructure
    -   server : ubuntu v20.04
    -   nginx v
    -   docker v
        -   PostgreSQL
        -   Redis

### ✅ Nginx 설치

```jsx
$ sudo apt-get install nginx
```

### ✅ Encrypt(SSL 발급)

```jsx
$ sudo apt-get install letsencrypt
$ sudo letsencrypt certonly --standalone -d [도메인]
```

### 📋 Nginx 설정

```
# Default server configuration
#
server {

	# SSL configuration
	#
	# listen 443 ssl default_server;
	# listen [::]:443 ssl default_server;
	#
	# Note: You should disable gzip for SSL traffic.
	# See: https://bugs.debian.org/773332
	#
	# Read up on ssl_ciphers to ensure a secure configuration.
	# See: https://bugs.debian.org/765782
	#
	# Self signed certs generated by the ssl-cert package
	# Don't use them in a production server!
	#
	# include snippets/snakeoil.conf;

	#root /home/ubuntu/S10P22E202/navigate_test/build/;
	root /var/www/html/;


	# Add index.php to the list if you are using PHP
	index index.html index.htm index.nginx-debian.html;

	server_name j10e202.p.ssafy.io;

	location / {
		# First attempt to serve request as file, then
		# as directory, then fall back to displaying a 404.
		try_files $uri $uri/ /index.html;

	}
    location /api-docs {
        proxy_pass http://localhost:8080/api-docs;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
	location /api {
        proxy_pass  http://localhost:8080;
        proxy_set_header X-Real-Ip $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $http_host;
        client_max_body_size 10M; 	# 요청할 수 있는 파일의 크기 최댓 값
    }
    location /oauth2 {
        proxy_pass  http://localhost:8080;
        proxy_set_header X-Real-Ip $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $http_host;
    }
	# pass PHP scripts to FastCGI server
	#
	#location ~ \.php$ {
	#	include snippets/fastcgi-php.conf;
	#
	#	# With php-fpm (or other unix sockets):
	#	fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
	#	# With php-cgi (or other tcp sockets):
	#	fastcgi_pass 127.0.0.1:9000;
	#}

	# deny access to .htaccess files, if Apache's document root
	# concurs with nginx's one
	#
	#location ~ /\.ht {
	#	deny all;
	#}

    listen [::]:443 ssl ipv6only=on; # managed by Certbot
    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/j10e202.p.ssafy.io/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/j10e202.p.ssafy.io/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
}

server {
    if ($host = j10e202.p.ssafy.io) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


	listen 80 default_server;
	listen [::]:80 default_server;

	server_name j10e202.p.ssafy.io;
    return 404; # managed by Certbot
}
```

### ✅ Docker 설치

#### Set up the repository

1. Update the `apt` package index and install packages to allow `apt` to use a repository over HTTPS:

```
$ sudo apt-get update
$ sudo apt-get install \\
    ca-certificates \\
    curl \\
    gnupg \\
    lsb-release
```

2. Add Docker's official GPG key

```
$ sudo install -m 0755 -d /etc/apt/keyrings
$ sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
```

3. Use the following command to set up the repository

```
$ echo \\
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] <https://download.docker.com/linux/ubuntu> \\
$(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
```

#### Install Docker Engine

1. Update the apt package index

```
$ sudo apt-get update
```

2. Install Docker Engine, containerd, and Docker Compose

```
$ sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
```

### ✅ PostgreSQL 설치와 실행

```
$ sudo docker pull postgres
$ sudo docker run -d -p <Your>:<Port> -e POSTGRES_PASSWORD="<YourStrong@Passw0rd>" --name <YourContainerName> postgres
```

### ✅ Redis 설치와 실행

```
$ sudo docker pull redis
$ sudo docker run -d -p <Your>:<Port> --name <YourConatinerName> redis
```

### 📋 환경변수 형태

```jsx
---------React---------
.env 내 환경변수 설정

VITE_TMAP_API_KEY='{key}'
VITE_KAKAOMAP_API_KEY='{key}'
VITE_KAKAOMAP_REST_API_KEY='{key}'

---------Spring---------
application.yml 내 환경변수 설정

spring :
    profiles:
        active: ${profile}
    output:
        ansi:
            enabled: ALWAYS
    servlet:
        multipart:
            max-file-size: 50MB
            max-request-size: 50MB
#logging
logging:
    level:
        root: info
        org:
            hibernate:
                orm:
                    jdbc:
                        bind: trace
    pattern:
        file: "%d %-5level [%thread] %logger : %msg%n"
#swagger
springdoc:
    packages-to-scan: com.dororo.api
    default-consumes-media-type: application/json;charset=UTF-8
    default-produces-media-type: application/json;charset=UTF-8
    api-docs:
        path: /api/api-docs
    swagger-ui:
        path: /api/docs # Swagger 페이지로 접속할 경로
        disable-swagger-default-url: true   # 기본 페이지로 리디렉션 되지 않게 하는 설정입니다
        operations-sorter: alpha    # API를 엔드 포인트들의 알파벳 순서로 정렬
        enabled: true   # 외부에서 접속 가능하게 하는 설정

----------------------------------------------------------------------

application-{profile}.yml 내 환경변수 설정

secret-key: {secret-key}
spring :
  data:
    redis:
      host: {host-url}
      port: 6379
  security:
    oauth2:
      client:
        registration:
          naver:
            client-id: {id}
            client-secret: {secret}
            redirect-uri: '{baseUrl}/oauth2/callback/naver'
            authorization-grant-type: authorization_code
            scope: name
        provider:
          naver:
            authorization-uri: https://nid.naver.com/oauth2.0/authorize
            token-uri: https://nid.naver.com/oauth2.0/token
            user-info-uri: https://openapi.naver.com/v1/nid/me
            user-name-attribute: response
  datasource:
    driver-class-name: org.postgresql.Driver
    url: jdbc:postgresql://{domain/db-name}
    username: {username}
    password: {password}
  jpa:
    show-sql: true
    hibernate:
      ddl-auto: none
      format_sql: true
      jdbc:
        lob:
          non_contextual_creation: true
    database: postgresql
    database-platform: org.hibernate.spatial.dialect.postgis.PostgisPG95Dialect
cloud:
  aws:
    region:
      static: ap-northeast-2
      auto: false # 자동 region 탐지 옵션. false로 설정했으므로 위의 ap-northeast-2(서울 region)으로 적용 됨
    s3:
      bucket: {bucket-name}
    stack:  # AWS CloudFormation 스택과 연동하여 리소스의 자동 감지 및 구성을 활성화 할 지 여부. false는 CloudFormation 스택을 통한 리소스 관리나 자동 감지를 사용하지 않겠다는 의미
      auto: false
    credentials:
        access-key: {key}
        secret-key: {key}
```

## 2. 배포

### 수동배포 방법

1. 소스 코드 복제

    $ git clone https://lab.ssafy.com/s10-bigdata-recom-sub2/S10P22E202.git

2. FrontEnd

```
$ cd /path-to-git-directory/client
$ npm ci
$ npm run build
$ sudo rm -rf /var/www/html/* && sudo cp -r /home/ubuntu/cd_client/* /var/www/html/
```

3. BackEnd

```
$ cd /path-to-git-directory/server
$ chmod +x gradlew
$ ./gradlew build
$ cd /build/libs
$ nohup java -jar -Dspring.profiles.active={your-want-profile} dororo-0.0.1-SNAPSHOT.jar
```

---

## 3. 외부 서비스

### 소셜 로그인

1. 네이버 개발자 센터에서 내 어플리케이션 등록
2. API 설정, Callback URL, 서비스 URL 지정

-   네이버 로그인 : https://developers.naver.com/docs/login/overview/overview.md

---

## 4. 시연 시나리오
